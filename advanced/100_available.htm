<html class="translated-ltr"><head>
    <title>How to achieve unattended 100% swoole server</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gbk">
    <link rel="stylesheet" href="../public/css/Word2Chm.css" type="text/css">
    <link rel="stylesheet" href="../public/css/default.css" type="text/css">
    <link rel="stylesheet" href="../public/css/noframe.css" type="text/css">
    <link rel="stylesheet" href="../public/css/bootstrap.css" type="text/css">
    <link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"></head>
    <body>
        <div class="wiki_content">
            <article>
                <h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to achieve unattended 100% swoole server</font></font></h1>
                
                <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In some cases, such as the system load is too large, swoole can not apply for memory and hang, the bottom of the swoole is a segmentation error, the server is too large to be used by the kernel Kill, or is accidentally killed by some programs. </font><font style="vertical-align: inherit;">The swoole-server will not be able to provide services, resulting in business disruption and loss of company revenue.</font></font></p>
                <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    There is a very effective and common solution for large companies such as BAT is crontab restart monitoring. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                    The principle is to execute a shell script every 1 minute to check if the server's master process is alive and skip if it exists. </font><font style="vertical-align: inherit;">If the main process is found to have been hanged, execute the restart logic to kill all remaining child processes and restart the server.
                </font></font></p>
                <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you add in the system's crontab:</font></font></p>
                <pre class="brush: php;">*/1 * * * * /data/script/check_server.sh
    </pre>
                <p>/data/script/check_server.shï¼š</p>
                <pre class="brush: php;">count=`ps -fe |grep "server.php" | grep -v "grep" | grep "master" | wc -l`<font></font>
    <font></font>
    echo $count<font></font>
    if [ $count -lt 1 ]; then<font></font>
    ps -eaf |grep "server.php" | grep -v "grep"| awk '{print $2}'|xargs kill -9<font></font>
    sleep 2<font></font>
    ulimit -c unlimited<font></font>
    /usr/local/bin/php /data/webroot/server.php<font></font>
    echo "restart";<font></font>
    echo $(date +%Y-%m-%d_%H:%M:%S) &gt;/data/log/restart.log<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    be</font></font><font></font>
    </pre>
                <h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where it can be improved</font></font></h2>
                <ul>
                    <li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can check if the port is listening through netstat -lnp, or restart if it is not listening.</font></font></li>
                    <li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Send a logical request through a check.php, test if the server can work normally, if it can not work, execute restart</font></font></li>
                    <li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a tool that uses the supervisor to monitor processes</font></font></li>
                </ul>
            </article>
            
        </div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>
    
    
    <div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>