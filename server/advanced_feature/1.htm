<html class="translated-ltr"><head>
	<title>Change the user/group of the Worker process</title>
	<meta http-equiv="Content-Type" content="text/html; charset=gbk">
	<link rel="stylesheet" href="../../public/css/Word2Chm.css" type="text/css">
	<link rel="stylesheet" href="../../public/css/default.css" type="text/css">
	<link rel="stylesheet" href="../../public/css/noframe.css" type="text/css">
	<link rel="stylesheet" href="../../public/css/bootstrap.css" type="text/css">
	<link rel="stylesheet" href="../../public/styles/shThemeDefault.css" type="text/css">
	<script type="text/javascript" src="../../public/scripts/shCore.js"></script>
	<script type="text/javascript" src="../../public/scripts/shBrushPhp.js"></script>
	<script type="text/javascript">
		SyntaxHighlighter.defaults['gutter'] = false;
		SyntaxHighlighter.defaults['toolbar'] = false;
		SyntaxHighlighter.all();
	</script>
<link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"></head>
<body>
	<div class="wiki_content">
		<article>
			<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the user/group of the Worker process</font></font></h1>

			<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
				In some cases, the main process needs to use Root to start, for example, need to listen to port 80. </font><font style="vertical-align: inherit;">At this time, the business code of the Worker process will also run under the root user, which is very unsafe. </font><font style="vertical-align: inherit;">Vulnerabilities in business code may cause the entire server to be compromised, so you need to change the users and groups to which the Worker process belongs to other users. </font><font style="vertical-align: inherit;">This can be done using the posix family of functions in PHP. </font><font style="vertical-align: inherit;">The following code can be added to the swoole's onWorkerStart callback:
			</font></font></p>
			<div><div id="highlighter_648392" class="syntaxhighlighter nogutter  php"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="php variable">$user</code> <code class="php plain">= posix_getpwnam(</code><code class="php string">'www-data'</code><code class="php plain">);</code></div><div class="line number2 index1 alt1"><code class="php plain">posix_setuid(</code><code class="php variable">$user</code><code class="php plain">[</code><code class="php string">'uid'</code><code class="php plain">]);</code></div><div class="line number3 index2 alt2"><code class="php plain">posix_setgid(</code><code class="php variable">$user</code><code class="php plain">[</code><code class="php string">'gid'</code><code class="php plain">]);</code></div></div></td></tr></tbody></table></div></div>
			<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redirect root directory</font></font></h2>
			<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
				The default is no redirection. Accessing the /etc/ directory in PHP code refers to the /etc/ of the file system, which is not safe. </font><font style="vertical-align: inherit;">For example, in the PHP code, the rm -rf / is executed by mistake. </font><font style="vertical-align: inherit;">Will have serious consequences. </font><font style="vertical-align: inherit;">You can use the chroot function to redirect the root directory to another secure directory.
			</font></font></p>
			<div><div id="highlighter_666078" class="syntaxhighlighter nogutter  php"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="php functions">chroot</code><code class="php plain">(</code><code class="php string">'/tmp/root/'</code><code class="php plain">);</code></div></div></td></tr></tbody></table></div></div>
			<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use the swoole configuration item</font></font></h2>
			<div><div id="highlighter_586519" class="syntaxhighlighter nogutter  php"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="php variable">$server</code><code class="php plain">-&gt;set(</code><code class="php keyword">array</code><code class="php plain">(</code><code class="php string">'chroot'</code> <code class="php plain">=&gt; </code><code class="php string">'/tmp/root'</code><code class="php plain">, </code><code class="php string">'user'</code> <code class="php plain">=&gt; </code><code class="php string">'www-data'</code><code class="php plain">, </code><code class="php string">'group'</code> <code class="php plain">=&gt; </code><code class="php string">'www-data'</code><code class="php plain">));</code></div></div></td></tr></tbody></table></div></div>
		</article>

	</div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>