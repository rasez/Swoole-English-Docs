<html class="translated-ltr"><head>
    <title>WebSocket - event callback function</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gbk">
    <link rel="stylesheet" href="../../public/css/Word2Chm.css" type="text/css">
    <link rel="stylesheet" href="../../public/css/default.css" type="text/css">
    <link rel="stylesheet" href="../../public/css/noframe.css" type="text/css">
    <link rel="stylesheet" href="../../public/css/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="../../public/styles/shThemeDefault.css" type="text/css">
    <script type="text/javascript" src="../../public/scripts/shCore.js"></script>
    <script type="text/javascript" src="../../public/scripts/shBrushPhp.js"></script>
    <script type="text/javascript">
        SyntaxHighlighter.defaults['gutter'] = false;
        SyntaxHighlighter.defaults['toolbar'] = false;
        SyntaxHighlighter.all();
    </script>
    <link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"></head>
    <body>
        <div class="wiki_content">
            <article>
                <h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event callback function</font></font></h1>
                
                <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example:</font></font></p>
                <div><div id="highlighter_797818" class="syntaxhighlighter nogutter  php"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="php plain">&lt;?php</code></div><div class="line number2 index1 alt1"><code class="php variable">$server</code> <code class="php plain">= </code><code class="php keyword">new</code> <code class="php plain">swoole_websocket_server(</code><code class="php string">"0.0.0.0"</code><code class="php plain">, 9501);</code></div><div class="line number3 index2 alt2"><code class="php comments">//$server = new swoole_websocket_server("0.0.0.0", 9501, SWOOLE_BASE);</code></div><div class="line number4 index3 alt1"><code class="php variable">$server</code><code class="php plain">-&gt;addlistener(</code><code class="php string">'0.0.0.0'</code><code class="php plain">, 9502, SWOOLE_SOCK_UDP);</code></div><div class="line number5 index4 alt2"><code class="php variable">$server</code><code class="php plain">-&gt;set([</code><code class="php string">'worker_num'</code> <code class="php plain">=&gt; 4]);</code></div><div class="line number6 index5 alt1"><code class="php keyword">function</code> <code class="php plain">user_handshake(swoole_http_request </code><code class="php variable">$request</code><code class="php plain">, swoole_http_response </code><code class="php variable">$response</code><code class="php plain">)</code></div><div class="line number7 index6 alt2"><code class="php plain">{</code></div><div class="line number8 index7 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//自定定握手规则，没有设置则用系统内置的（只支持version:13的）</code></div><div class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(!isset(</code><code class="php variable">$request</code><code class="php plain">-&gt;header[</code><code class="php string">'sec-websocket-key'</code><code class="php plain">]))</code></div><div class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></div><div class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//'Bad protocol implementation: it is not RFC6455.'</code></div><div class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$response</code><code class="php plain">-&gt;</code><code class="php functions">end</code><code class="php plain">();</code></div><div class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">false;</code></div><div class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(0 === preg_match(</code><code class="php string">'#^[+/0-9A-Za-z]{21}[AQgw]==$#'</code><code class="php plain">, </code><code class="php variable">$request</code><code class="php plain">-&gt;header[</code><code class="php string">'sec-websocket-key'</code><code class="php plain">])</code></div><div class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">|| 16 !== </code><code class="php functions">strlen</code><code class="php plain">(</code><code class="php functions">base64_decode</code><code class="php plain">(</code><code class="php variable">$request</code><code class="php plain">-&gt;header[</code><code class="php string">'sec-websocket-key'</code><code class="php plain">]))</code></div><div class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">)</code></div><div class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></div><div class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//Header Sec-WebSocket-Key is illegal;</code></div><div class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$response</code><code class="php plain">-&gt;</code><code class="php functions">end</code><code class="php plain">();</code></div><div class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">false;</code></div><div class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$key</code> <code class="php plain">= </code><code class="php functions">base64_encode</code><code class="php plain">(sha1(</code><code class="php variable">$request</code><code class="php plain">-&gt;header[</code><code class="php string">'sec-websocket-key'</code><code class="php plain">]</code></div><div class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">. </code><code class="php string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</code><code class="php plain">,</code></div><div class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">true));</code></div><div class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$headers</code> <code class="php plain">= </code><code class="php keyword">array</code><code class="php plain">(</code></div><div class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'Upgrade'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php string">'websocket'</code><code class="php plain">,</code></div><div class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'Connection'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php string">'Upgrade'</code><code class="php plain">,</code></div><div class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'Sec-WebSocket-Accept'</code>&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$key</code><code class="php plain">,</code></div><div class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'Sec-WebSocket-Version'</code> <code class="php plain">=&gt; </code><code class="php string">'13'</code><code class="php plain">,</code></div><div class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'KeepAlive'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php string">'off'</code><code class="php plain">,</code></div><div class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">);</code></div><div class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">foreach</code> <code class="php plain">(</code><code class="php variable">$headers</code> <code class="php keyword">as</code> <code class="php variable">$key</code> <code class="php plain">=&gt; </code><code class="php variable">$val</code><code class="php plain">)</code></div><div class="line number34 index33 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></div><div class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$response</code><code class="php plain">-&gt;header(</code><code class="php variable">$key</code><code class="php plain">, </code><code class="php variable">$val</code><code class="php plain">);</code></div><div class="line number36 index35 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number37 index36 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$response</code><code class="php plain">-&gt;status(101);</code></div><div class="line number38 index37 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$response</code><code class="php plain">-&gt;</code><code class="php functions">end</code><code class="php plain">();</code></div><div class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">true;</code></div><div class="line number40 index39 alt1"><code class="php plain">}</code></div><div class="line number41 index40 alt2"><code class="php variable">$server</code><code class="php plain">-&gt;on(</code><code class="php string">'handshake'</code><code class="php plain">, </code><code class="php string">'user_handshake'</code><code class="php plain">);</code></div><div class="line number42 index41 alt1"><code class="php variable">$server</code><code class="php plain">-&gt;on(</code><code class="php string">'open'</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">(swoole_websocket_server </code><code class="php variable">$_server</code><code class="php plain">, swoole_http_request </code><code class="php variable">$request</code><code class="php plain">) {</code></div><div class="line number43 index42 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">echo</code> <code class="php string">"server#{$_server-&gt;worker_pid}: handshake success with fd#{$request-&gt;fd}\n"</code><code class="php plain">;</code></div><div class="line number44 index43 alt1"><code class="php comments">//&nbsp;&nbsp;&nbsp; var_dump($request);</code></div><div class="line number45 index44 alt2"><code class="php plain">});</code></div><div class="line number46 index45 alt1"><code class="php variable">$server</code><code class="php plain">-&gt;on(</code><code class="php string">'message'</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">(swoole_websocket_server </code><code class="php variable">$_server</code><code class="php plain">, </code><code class="php variable">$frame</code><code class="php plain">) {</code></div><div class="line number47 index46 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">var_dump(</code><code class="php variable">$frame</code><code class="php plain">);</code></div><div class="line number48 index47 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">echo</code> <code class="php string">"received "</code><code class="php plain">.</code><code class="php functions">strlen</code><code class="php plain">(</code><code class="php variable">$frame</code><code class="php plain">-&gt;data).</code><code class="php string">" bytes\n"</code><code class="php plain">;</code></div><div class="line number49 index48 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//echo "receive from {$fd}:{$data},opcode:{$opcode},fin:{$fin}\n";</code></div><div class="line number50 index49 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$_server</code><code class="php plain">-&gt;push(</code><code class="php variable">$frame</code><code class="php plain">-&gt;fd, </code><code class="php string">"this is server"</code><code class="php plain">);</code></div><div class="line number51 index50 alt2"><code class="php comments">//&nbsp; $_server-&gt;close($frame-&gt;fd);</code></div><div class="line number52 index51 alt1"><code class="php plain">});</code></div><div class="line number53 index52 alt2"><code class="php variable">$server</code><code class="php plain">-&gt;on(</code><code class="php string">'close'</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">(</code><code class="php variable">$_server</code><code class="php plain">, </code><code class="php variable">$fd</code><code class="php plain">) {</code></div><div class="line number54 index53 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">echo</code> <code class="php string">"client {$fd} closed\n"</code><code class="php plain">;</code></div><div class="line number55 index54 alt2"><code class="php plain">});</code></div><div class="line number56 index55 alt1"><code class="php variable">$server</code><code class="php plain">-&gt;on(</code><code class="php string">'packet'</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">(</code><code class="php variable">$_server</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">, </code><code class="php variable">$client</code><code class="php plain">) {</code></div><div class="line number57 index56 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">echo</code> <code class="php string">"#"</code><code class="php plain">.posix_getpid().</code><code class="php string">"\tPacket {$data}\n"</code><code class="php plain">;</code></div><div class="line number58 index57 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">var_dump(</code><code class="php variable">$client</code><code class="php plain">);</code></div><div class="line number59 index58 alt2"><code class="php plain">});</code></div><div class="line number60 index59 alt1"><code class="php variable">$server</code><code class="php plain">-&gt;start();</code></div></div></td></tr></tbody></table></div></div>
            </article>
            
        </div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>
    
    
    <div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>